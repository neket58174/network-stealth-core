name: Self-hosted Smoke
run-name: "Self-hosted Smoke / ${{ github.ref_name }} / ${{ github.event_name }}"

on:
  workflow_dispatch:

jobs:
  lifecycle-smoke:
    name: lifecycle smoke (${{ vars.XRAY_ENABLE_SELF_HOSTED_ACTIONS == 'true' && 'self-hosted' || 'ubuntu-24.04' }})
    runs-on: ${{ fromJSON(vars.XRAY_ENABLE_SELF_HOSTED_ACTIONS == 'true' && '["self-hosted","linux"]' || '["ubuntu-24.04"]') }}
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Runner mode
        run: |
          if [[ "${{ vars.XRAY_ENABLE_SELF_HOSTED_ACTIONS }}" == "true" ]]; then
            echo "Self-hosted mode enabled"
          else
            echo "Self-hosted mode disabled, fallback to ubuntu-24.04"
          fi
      - name: Install dependencies (best-effort)
        run: |
          set -euo pipefail
          install_cmd=""
          if command -v apt-get >/dev/null 2>&1; then
            install_cmd="apt-get update -qq && apt-get install -y expect jq bats shellcheck"
          elif command -v dnf >/dev/null 2>&1; then
            install_cmd="dnf -y install expect jq bats shellcheck"
          elif command -v yum >/dev/null 2>&1; then
            install_cmd="yum -y install expect jq bats shellcheck"
          fi
          if [[ -n "$install_cmd" ]]; then
            if [[ "${EUID:-$(id -u)}" -eq 0 ]]; then
              bash -lc "$install_cmd"
            elif command -v sudo >/dev/null 2>&1; then
              sudo bash -lc "$install_cmd"
            fi
          fi
      - name: Run lint, complexity stage-3 and self-hosted lifecycle smoke
        run: |
          set -euo pipefail
          bash tests/lint.sh --fast
          COMPLEXITY_STAGE=3 bash scripts/check-shell-complexity.sh
          chmod +x tests/e2e/nightly_smoke_install_add_update_uninstall.sh
          tests/e2e/nightly_smoke_install_add_update_uninstall.sh
